<html>

<head>
	<link rel="stylesheet" href="Style.css">
</head>

<body>

<div id="divUi">

	<h3>Musical Keyboard</h3>

	<p>
		Click the buttons or press keys to play musical notes. 
		Click Record/Stop to start recording, play some notes,
		and click Record/Stop again to stop recording, then click Play
		to play back the recorded notes.
	</p>

	<div>
		<label>Voice:</label>
		<select id="selectVoiceName" onchange="selectVoiceName_Changed(this)" >
			<option>Sine</option>
			<option>Square</option>
			<option>Sawtooth</option>
			<option>Triangle</option>
		</select>
	</div>

	<div>
		<label>Volume as Percentage of Max:</label>
		<input
			id="inputVolumeAsPercentageOfMax"
			type="number" min="0" max="100" step="1"
			value="10"
			onchange="inputVolumeAsPercentageOfMax_Changed(this)"
		></input>
	</div>

	<div>
		<button class="white" onmousedown="buttonPlayNote_Clicked(0)">C</button>
		<button class="black" onmousedown="buttonPlayNote_Clicked(1)"></button>
		<button class="white" onmousedown="buttonPlayNote_Clicked(2)">D</button>
		<button class="black" onmousedown="buttonPlayNote_Clicked(3)"></button>
		<button class="white" onmousedown="buttonPlayNote_Clicked(4)">E</button>
		<button class="white" onmousedown="buttonPlayNote_Clicked(5)">F</button>
		<button class="black" onmousedown="buttonPlayNote_Clicked(6)"></button>
		<button class="white" onmousedown="buttonPlayNote_Clicked(7)">G</button>
		<button class="black" onmousedown="buttonPlayNote_Clicked(8)"></button>
		<button class="white" onmousedown="buttonPlayNote_Clicked(9)">A</button>
		<button class="black" onmousedown="buttonPlayNote_Clicked(10)"></button>
		<button class="white" onmousedown="buttonPlayNote_Clicked(11)">B</button>

		<button class="white" onmousedown="buttonPlayNote_Clicked(12)">C</button>
		<button class="black" onmousedown="buttonPlayNote_Clicked(13)"></button>
		<button class="white" onmousedown="buttonPlayNote_Clicked(14)">D</button>
		<button class="black" onmousedown="buttonPlayNote_Clicked(15)"></button>
		<button class="white" onmousedown="buttonPlayNote_Clicked(16)">E</button>
		<button class="white" onmousedown="buttonPlayNote_Clicked(17)">F</button>
		<button class="black" onmousedown="buttonPlayNote_Clicked(18)"></button>
		<button class="white" onmousedown="buttonPlayNote_Clicked(19)">G</button>
		<button class="black" onmousedown="buttonPlayNote_Clicked(20)"></button>
		<button class="white" onmousedown="buttonPlayNote_Clicked(21)">A</button>
		<button class="black" onmousedown="buttonPlayNote_Clicked(22)"></button>
		<button class="white" onmousedown="buttonPlayNote_Clicked(23)">B</button>
	</div>

	<div>
		<label>Recording:</label>
		<input id="checkboxIsRecording" type="checkbox" value="false" disabled="true"></input>
		<button onmousedown="buttonRecordOrStop_Clicked()">Record/Stop</button>
		<button onmousedown="buttonRecordingPlay_Clicked()">Play</button>
		<br />
		<textarea id="textareaRecording" cols="40" rows="16"></textarea>
	</div>
</div>

<script type="text/javascript">

// Initialize.

var body = document.body;
body.onkeydown = body_KeyDown;
body.onkeyup = body_KeyUp;
body.onmouseup = buttonPlayNote_Released;

// Event handlers.

function body_KeyDown(event)
{
	var key = event.key;
	var inputTracker = InputTracker.Instance;
	var isKeyPressed = inputTracker.isKeyPressed(key);
	if (isKeyPressed == false)
	{
		inputTracker.keyPress(key);
		var musicalKeyboard = MusicalKeyboard.Instance();
		var pitchIndex = musicalKeyboard.pitchIndexForKey(key);
		if (pitchIndex != null)
		{
			var pitchInHertz = musicalKeyboard.pitchInHertzForIndex(pitchIndex);
			musicalKeyboard.playNoteWithPitchInHertz(pitchInHertz);
		}
	}
}

function body_KeyUp(event)
{
	var key = event.key;
	InputTracker.Instance.keyRelease(key);
	var musicalKeyboard = MusicalKeyboard.Instance();
	musicalKeyboard.stopNote(); // todo - Polytonicity.
}

function buttonRecordOrStop_Clicked()
{
	var musicalKeyboard = MusicalKeyboard.Instance();
	musicalKeyboard.recordingStartOrStop();
	var d = document;
	var checkboxIsRecording = d.getElementById("checkboxIsRecording");
	checkboxIsRecording.checked = musicalKeyboard.isRecording();
}

function buttonRecordingClear_Clicked()
{
	var d = document;
	var textareaRecording = d.getElementById("textareaRecording");
	textareaRecording.value = "";
}

function buttonRecordingPlay_Clicked()
{
	var d = document;
	var textareaRecording = d.getElementById("textareaRecording");
	var recordingAsText = textareaRecording.value;
	var musicalKeyboard = MusicalKeyboard.Instance();
	musicalKeyboard.recordingPlay(recordingAsText);
}

function buttonPlayNote_Clicked(pitchIndex)
{
	if (pitchIndex != null)
	{
		var musicalKeyboard = MusicalKeyboard.Instance();
		var pitchInHertz = musicalKeyboard.pitchInHertzForIndex(pitchIndex);
		musicalKeyboard.playNoteWithPitchInHertz(pitchInHertz);
	}
}

function buttonPlayNote_Released()
{
	var musicalKeyboard = MusicalKeyboard.Instance();
	musicalKeyboard.stopNote();
}

function inputVolumeAsPercentageOfMax_Changed(inputVolumeAsPercentageOfMax)
{
	var volumeAsPercentageOfMaxAsString =
		inputVolumeAsPercentageOfMax.value;
	var volumeAsPercentageOfMax =
		parseInt(volumeAsPercentageOfMaxAsString);
	if (volumeAsPercentageOfMax < 0)
	{
		volumeAsPercentageOfMax = 0;
	}
	else if (volumeAsPercentageOfMax > 100)
	{
		volumeAsPercentageOfMax = 100;
	}
	inputVolumeAsPercentageOfMax.value = volumeAsPercentageOfMax;
	var volumeAsFractionOfMax = volumeAsPercentageOfMax / 100;
	var musicalKeyboard = MusicalKeyboard.Instance();
	musicalKeyboard.volumeAsFractionOfMaxSet(volumeAsFractionOfMax);
}

function selectVoiceName_Changed(selectVoiceName)
{
	var musicalKeyboard = MusicalKeyboard.Instance();
	musicalKeyboard.voiceNameSet(selectVoiceName.value);
}

// Classes.

class InputTracker
{
	constructor()
	{
		this.keysPressed = [];
	}

	static Instance = new InputTracker();

	isKeyPressed(key)
	{
		return (this.keysPressed.indexOf(key) >= 0);
	}

	keyPress(key)
	{
		if (this.keysPressed.indexOf(key) == -1)
		{
			this.keysPressed.push(key);
		}
	}

	keyRelease(key)
	{
		var keyIndex = this.keysPressed.indexOf(key);
		if (keyIndex >= 0)
		{
			this.keysPressed.splice(keyIndex, 1);
		}
	}
}

class MusicalKeyboard
{
	constructor
	(
		voiceName, volumeAsFractionOfMax
	)
	{
		this.voiceName = voiceName || "Sine";
		this.volumeAsFractionOfMax = volumeAsFractionOfMax || .1;

		this.pitchIndicesByKey = this.pitchIndicesByKeyBuild();
		this.initialize();
	}

	static Instance()
	{
		if (MusicalKeyboard._instance == null)
		{
			MusicalKeyboard._instance = new MusicalKeyboard();
		}
		return MusicalKeyboard._instance;
	}

	initialize()
	{
		this.audio = new AudioContext();

		this.gain = this.audio.createGain();
		this.gain.connect(this.audio.destination);

		this.oscillator = this.audio.createOscillator();
		this.oscillator.type = this.voiceName.toLowerCase();
		this.oscillator.connect(this.gain);
		this.oscillator.start();
	}

	isRecording()
	{
		return (this.recordingStartTime != null);
	}

	pitchInHertzForIndex(pitchIndex)
	{
		var pitchInHertzForLowA = 110;

		var pitchInHertz = pitchInHertzForLowA;

		var tonesPerOctave = 12;

		var octaveIndex = Math.floor(pitchIndex / tonesPerOctave);
		for (var i = 0; i < octaveIndex; i++)
		{
			pitchInHertz *= 2;
		}

		var pitchOffsetWithinOctave =
			pitchIndex % tonesPerOctave;
		var pitchNextMultiplier =
			Math.pow(2, 1/tonesPerOctave);

		for (var i = 0; i < pitchOffsetWithinOctave; i++)
		{
			pitchInHertz *= pitchNextMultiplier;
		}

		pitchInHertz = Math.round(pitchInHertz);

		return pitchInHertz;
	}

	pitchIndexForKey(key)
	{
		return this.pitchIndicesByKey.get(key);
	}

	pitchIndicesByKeyBuild()
	{
		return new Map
		([
			// first octave
			[ "Z", 3 ], // b
			[ "X", 4 ], // c
			[ "D", 5 ], // c#
			[ "C", 6 ], // d
			[ "F", 7 ], // d#
			[ "V", 8 ], // e
			[ "B", 9 ], // f
			[ "H", 10 ], // f#
			[ "N", 11 ], // g
			[ "J", 12 ], // g#
			[ "M", 13 ], // a
			[ "K", 14 ], // a#
			[ "<", 15 ], // b
			[ ">", 16 ], // c
			[ ":", 17 ], // c#
			[ "?", 18 ], // d

			// second octave
			[ "z", 15 ], // b
			[ "x", 16 ], // c
			[ "d", 17 ], // c#
			[ "c", 18 ], // d
			[ "f", 19 ], // d#
			[ "v", 20 ], // e
			[ "b", 21 ], // f
			[ "h", 22 ], // f#
			[ "n", 23 ], // g
			[ "j", 24 ], // g#
			[ "m", 25 ], // a
			[ "k", 26 ], // a#
			[ ",", 27 ], // b
			[ ".", 28 ], // c
			[ ";", 29 ], // c#
			[ "/", 30 ] // d
		]);
	}

	playNoteWithPitchInHertz(pitchInHertz)
	{
		var offsetInSeconds = this.audio.currentTime;

		this.oscillator.frequency.setValueAtTime
		(
			pitchInHertz, offsetInSeconds
		);

		this.gain.gain.setValueAtTime
		(
			this.volumeAsFractionOfMax, offsetInSeconds
		);

		if (this.isRecording())
		{
			var now = new Date();
			var millisecondsSinceRecordingStarted =
				now - this.recordingStartTime;

			this.noteInProgress = new Note
			(
				millisecondsSinceRecordingStarted,
				pitchInHertz
			);
		}
	}

	recordNoteIfRecording()
	{
		if (this.isRecording() )
		{
			var note = this.noteInProgress;

			if (note != null)
			{
				var now = new Date();
				var millisecondsSinceRecordingStarted =
					now - this.recordingStartTime;
				var durationInMilliseconds =
					millisecondsSinceRecordingStarted
					- note.millisecondsSinceRecordingStarted;
				note.durationInMilliseconds = durationInMilliseconds;
				this.notesRecorded.push(note);

				var notesRecordedAsString =
					this.notesRecorded.map(x => x.toStringForRecording() ).join(";");
				var d = document;
				var textareaRecording = d.getElementById("textareaRecording");
				textareaRecording.value = notesRecordedAsString;
			}
		}
	}

	recordingPlay(recordingAsText)
	{
		var d = document;
		var textareaRecording = d.getElementById("textareaRecording");
		textareaRecording.value = recordingAsText;

		var notesAsStrings = recordingAsText.split(";");
		this.notesRecorded = notesAsStrings.map(x => Note.fromString(x) );

		var playbackStartTimeInSeconds = this.audio.currentTime;
		var millisecondsPerSecond = 1000;

		this.notesRecorded.forEach
		(
			note =>
			{
				var pitchInHertz = note.pitchInHertz;
				var noteStartRelativeToRecordingStartInSeconds =
					note.millisecondsSinceRecordingStarted / millisecondsPerSecond;
				var noteStartAbsoluteInSeconds =
					playbackStartTimeInSeconds
					+ noteStartRelativeToRecordingStartInSeconds;
				var durationInSeconds =
					note.durationInMilliseconds / millisecondsPerSecond;
				var noteEndAbsoluteInSeconds =
					noteStartAbsoluteInSeconds + durationInSeconds;

				this.oscillator.frequency.setValueAtTime
				(
					pitchInHertz, noteStartAbsoluteInSeconds
				);

				this.gain.gain.setValueAtTime
				(
					this.volumeAsFractionOfMax, noteStartAbsoluteInSeconds
				);

				this.gain.gain.setValueAtTime
				(
					0, noteEndAbsoluteInSeconds
				);

			}
		);
	}

	recordingStartOrStop()
	{
		if (this.isRecording())
		{
			this.recordingStartTime = null;
		}
		else
		{
			this.recordingStartTime = new Date();
			this.notesRecorded = [];
		}
	}

	stopNote()
	{
		var offsetInSeconds = this.audio.currentTime;

		this.gain.gain.setValueAtTime
		(
			0, offsetInSeconds
		);

		this.recordNoteIfRecording();
	}

	voiceNameSet(value)
	{
		this.voiceName = value;
		return this;
	}

	volumeAsFractionOfMaxSet(value)
	{
		this.volumeAsFractionOfMax = value;
		return this;
	}
}

class Note
{
	constructor
	(
		millisecondsSinceRecordingStarted,
		pitchInHertz,
		durationInMilliseconds
	)
	{
		this.millisecondsSinceRecordingStarted = millisecondsSinceRecordingStarted;
		this.pitchInHertz = pitchInHertz;
		this.durationInMilliseconds = durationInMilliseconds;
	}

	// String.

	static fromString(stringToParse)
	{
		var parts = stringToParse.split(":");
		var millisecondsSinceRecordingStarted = parseInt(parts[0]);
		var pitchInHertz = parseFloat(parts[1]);
		var durationInMilliseconds = parseInt(parts[2]);
		var note = new Note
		(
			millisecondsSinceRecordingStarted,
			pitchInHertz,
			durationInMilliseconds
		);
		return note;
	}

	toStringForRecording()
	{
		var returnValue =
			this.millisecondsSinceRecordingStarted
			+ ":" + this.pitchInHertz
			+ ":" + this.durationInMilliseconds;

		return returnValue;
	}
}
</script>

</body>
</html>
